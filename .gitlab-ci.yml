image: docker:latest
services:
  - docker:dind

stages:
  - build
  - test
  - publish
  - release

variables:
  DOCKER_TLS_CERTDIR: "/certs"

workflow:
  rules:
    # Run if we trigger a pipeline from the web
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run if this is a merge request
    - if: $CI_MERGE_REQUEST_ID

before_script:
  - apk add bash
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

.centos:
  variables:
    CINC_IMAGE: "omnibus-centos"
    VERSIONS: "6 7 8"

.debian:
  variables:
    CINC_IMAGE: "omnibus-debian"
    VERSIONS: "8 9 10"

.opensuse:
  variables:
    CINC_IMAGE: "omnibus-opensuse"
    VERSIONS: "15"

.ubuntu:
  variables:
    CINC_IMAGE: "omnibus-ubuntu"
    VERSIONS: "16.04 18.04 20.04"

.build:
  stage: build
  tags:
    - osuosl
  rules:
    - changes:
      - "${CINC_IMAGE}/*"
      when: on_success
    - if: $CINC_BUILD == $CINC_IMAGE
      when: on_success
    - if: $CINC_BUILD == "all"
      when: on_success
    - when: never
  script:
    - bash scripts/build.sh

build:omnibus-centos:
  extends:
    - .centos
    - .build

build:omnibus-debian:
  extends:
    - .debian
    - .build

build:omnibus-opensuse:
  extends:
    - .opensuse
    - .build

build:omnibus-ubuntu:
  extends:
    - .ubuntu
    - .build

.test:
  stage: test
  image: cincproject/docker-auditor
  tags:
    - osuosl
  rules:
    - changes:
      - "${CINC_IMAGE}/*"
      when: on_success
    - if: $CINC_BUILD == $CINC_IMAGE
      when: on_success
    - if: $CINC_BUILD == "all"
      when: on_success
    - when: never
  script:
    - bash scripts/test.sh

test:omnibus-centos:
  extends:
    - .centos
    - .test

test:omnibus-debian:
  extends:
    - .debian
    - .test

test:omnibus-opensuse:
  extends:
    - .opensuse
    - .test

publish:omnibus-ubuntu:
  extends:
    - .ubuntu
    - .publish

.publish:
  stage: publish
  tags:
    - osuosl
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CINC_BUILD == $CINC_IMAGE
      when: on_success
    - if: $CINC_BUILD == "all"
      when: on_success
    - changes:
      - "${CINC_IMAGE}/*"
    - when: never
  script:
    - bash scripts/publish.sh

publish:omnibus-centos:
  extends:
    - .centos
    - .publish

publish:omnibus-debian:
  extends:
    - .debian
    - .publish

publish:omnibus-opensuse:
  extends:
    - .opensuse
    - .publish

publish:omnibus-ubuntu:
  extends:
    - .ubuntu
    - .publish

.release:
  tags:
    - osuosl
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CINC_BUILD == $CINC_IMAGE
      when: on_success
    - if: $CINC_BUILD == "all"
      when: on_success
    - changes:
      - "${CINC_IMAGE}/*"
    - when: never
  before_script:
    - apk add bc bash
  script:
    - bash scripts/publish.sh

release:omnibus-centos:
  extends:
    - .centos
    - .release

release:omnibus-debian:
  extends:
    - .debian
    - .release

release:omnibus-opensuse:
  extends:
    - .opensuse
    - .release

release:omnibus-ubuntu:
  extends:
    - .ubuntu
    - .release
